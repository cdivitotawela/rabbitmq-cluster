stream {

    log_format basic '$remote_addr [$time_local] '
                     '$protocol $status $bytes_sent $bytes_received '
                     '$session_time';
    access_log /var/log/rabbit-mgt.log basic;

    upstream rabbitmq-api {
        server mq01.rabbit.ops:15671 max_fails=1 fail_timeout=5s;
        server mq02.rabbit.ops:15671 max_fails=1 fail_timeout=5s;
        server mq03.rabbit.ops:15671 max_fails=1 fail_timeout=5s;
    }

    upstream rabbitmq-amqp {
        server mq01.rabbit.ops:5671 max_fails=1 fail_timeout=5s;
        server mq02.rabbit.ops:5671 max_fails=1 fail_timeout=5s;
        server mq03.rabbit.ops:5671 max_fails=1 fail_timeout=5s;
    }

    server {
        listen 15671;
        proxy_pass rabbitmq-api;
    }

    server {
        listen 5671;
        proxy_pass rabbitmq-amqp;
    }
}
